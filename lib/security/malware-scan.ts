import crypto from "crypto";

type ScanMode = "disabled" | "hash-denylist" | "webhook";

export type MalwareScanResult = {
  clean: boolean;
  source: ScanMode;
  sha256: string;
  reason?: string;
};

function getScanMode(): ScanMode {
  const mode = (process.env.AV_SCAN_MODE || "disabled").trim().toLowerCase();
  if (mode === "hash-denylist" || mode === "webhook" || mode === "disabled") {
    return mode;
  }
  return "disabled";
}

export async function scanFileForMalware(file: File): Promise<MalwareScanResult> {
  const buffer = Buffer.from(await file.arrayBuffer());
  const sha256 = crypto.createHash("sha256").update(buffer).digest("hex");
  const mode = getScanMode();

  if (mode === "disabled") {
    return { clean: true, source: "disabled", sha256 };
  }

  if (mode === "hash-denylist") {
    const blockedHashes = (process.env.AV_BLOCKED_SHA256 || "")
      .split(",")
      .map((value) => value.trim().toLowerCase())
      .filter(Boolean);

    if (blockedHashes.includes(sha256.toLowerCase())) {
      return {
        clean: false,
        source: "hash-denylist",
        sha256,
        reason: "File hash matched denylist",
      };
    }

    return { clean: true, source: "hash-denylist", sha256 };
  }

  const webhookUrl = process.env.AV_SCAN_WEBHOOK_URL;
  if (!webhookUrl) {
    throw new Error("AV_SCAN_WEBHOOK_URL is required when AV_SCAN_MODE=webhook");
  }

  const includeContent = process.env.AV_SCAN_INCLUDE_CONTENT === "true";
  const payload: Record<string, unknown> = {
    fileName: file.name,
    fileType: file.type,
    fileSize: file.size,
    sha256,
  };

  if (includeContent) {
    payload.base64Content = buffer.toString("base64");
  }

  const response = await fetch(webhookUrl, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...(process.env.AV_SCAN_WEBHOOK_TOKEN
        ? { Authorization: `Bearer ${process.env.AV_SCAN_WEBHOOK_TOKEN}` }
        : {}),
    },
    body: JSON.stringify(payload),
  });

  if (!response.ok) {
    throw new Error(`AV scan webhook failed with status ${response.status}`);
  }

  const result = (await response.json().catch(() => ({}))) as {
    clean?: boolean;
    reason?: string;
  };

  return {
    clean: result.clean !== false,
    source: "webhook",
    sha256,
    reason: result.reason,
  };
}
